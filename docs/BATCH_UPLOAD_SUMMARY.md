# æ‰¹æ¬¡ä¸Šä¼ é—®é¢˜åˆ†æ

## âŒ æ ¸å¿ƒé—®é¢˜

**æ‰¹æ¬¡å¿«é€Ÿå †ç§¯ - `ensureIndexCreated` å’Œ `fastRepoSyncComplete` åªæ˜¯é€šçŸ¥APIï¼Œä¸ç­‰å¾…æœåŠ¡å™¨å¤„ç†å®Œæˆ**

---

## ï¿½ é—®é¢˜æ ¹æº

### 1. API å“åº”ä¸ºç©ºï¼ˆæ— çŠ¶æ€è¿”å›ï¼‰

```protobuf
message EnsureIndexCreatedResponse {}      // ç©ºå“åº”
message FastRepoSyncCompleteResponse {}    // ç©ºå“åº”
```

### 2. å®é™…æ‰§è¡Œæµç¨‹

```typescript
for (let i = 0; i < batches.length; i++) {
  await uploadFilesChunk(batch);           // ä¸Šä¼ æ–‡ä»¶
  await ensureIndexCreated(...);           // å‘é€é€šçŸ¥ â†’ ç«‹å³è¿”å›
  await fastRepoSyncComplete(...);         // å‘é€é€šçŸ¥ â†’ ç«‹å³è¿”å›
  // âš ï¸ æ²¡æœ‰çœŸæ­£ç­‰å¾…æœåŠ¡å™¨å¤„ç†å®Œæˆï¼
}
```

### 3. æœåŠ¡å™¨ç«¯å®é™…æƒ…å†µ

```
å®¢æˆ·ç«¯: æ‰¹æ¬¡1é€šçŸ¥ â†’ æ‰¹æ¬¡2é€šçŸ¥ â†’ æ‰¹æ¬¡3é€šçŸ¥ â†’ ... (å¿«é€Ÿå‘é€)
æœåŠ¡å™¨: æ”¶åˆ°å¤§é‡æ–‡ä»¶ + å¤„ç†è¯·æ±‚ â†’ é˜Ÿåˆ—å †ç§¯ â†’ è¶…æ—¶å¤±è´¥
```

---

## ğŸ”¬ API æ¢ç´¢ç»“æœ

**æ£€æŸ¥äº†å®Œæ•´çš„ `proto/repository_service.proto`ï¼Œå‘ç°ï¼š**

- âŒ æ— çŠ¶æ€æŸ¥è¯¢ API
- âŒ æ— è½®è¯¢æœºåˆ¶
- âŒ æ— ç­‰å¾…ç¡®è®¤ API
- âœ… ä»…æœ‰é€šçŸ¥ç±» APIï¼ˆç«‹å³è¿”å›ï¼‰

**å”¯ä¸€å¯èƒ½çš„çŠ¶æ€æ£€æŸ¥ï¼š**
`FastRepoInitHandshakeV2Response` è¿”å› `RepositoryCodebaseInfo.status`ï¼Œä½†è¿™æ˜¯æ¡æ‰‹æ—¶çš„çŠ¶æ€ï¼Œä¸æ˜¯ä¸Šä¼ åçš„çŠ¶æ€ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå‡å°æ‰¹æ¬¡ + å¢åŠ å»¶è¿Ÿï¼ˆæ¨èï¼‰

```bash
# .env é…ç½®
INITIAL_UPLOAD_MAX_FILES=1      # æ¯æ‰¹ 1 ä¸ªæ–‡ä»¶
SYNC_CONCURRENCY=1              # 1 ä¸ªå¹¶å‘
PROTO_TIMEOUT_MS=60000          # 60 ç§’è¶…æ—¶
BATCH_DELAY_MS=5000             # æ‰¹æ¬¡é—´å»¶è¿Ÿ 5 ç§’
```

### æ–¹æ¡ˆ 2ï¼šæ·»åŠ æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆéœ€ä¿®æ”¹ä»£ç ï¼‰

åœ¨ `src/services/repositoryIndexer.ts:537` åæ·»åŠ ï¼š

```typescript
await runEnsureAndSyncComplete(...);

// æ·»åŠ å»¶è¿Ÿç»™æœåŠ¡å™¨å¤„ç†æ—¶é—´
if (i < batches.length - 1) {
  await new Promise(resolve => setTimeout(resolve, 5000));
}
```

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| é…ç½® | æ‰¹æ¬¡å¤§å° | å¹¶å‘ | å»¶è¿Ÿ | é¢„è®¡è€—æ—¶ | æˆåŠŸç‡ |
|------|---------|------|------|---------|--------|
| é»˜è®¤ | 10 | 4 | 0s | å¤±è´¥ | ä½ |
| ä¿å®ˆ | 3 | 2 | 3s | 1-2å°æ—¶ | ä¸­ |
| æç«¯ | 1 | 1 | 5s | 6-12å°æ—¶ | é«˜ |

